<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Marco Ferrari - Cloud Solutions Architect - Google | Unlocking an Android Smartphone with a Known Pattern Lock via ADB</title><meta name=description content="Recently my Nexus 4 touchscreen stoppedworking.I wasn’t worried at all because I set up an automatic backup schedule withTitanium Backupthat runs every night..."><link rel=canonical href=https://ferrarimarco.info/blog/mobile/security/2017/10/18/unlocking-android-pattern/ ><link rel=stylesheet href=/assets/stylesheets/style-f2990e49da.min.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/assets/images/touch/apple-touch-icon.png><link rel="shortcut icon" href=/favicon.ico><link type=application/atom+xml rel=alternate href=https://ferrarimarco.info/feed.xml title="Marco Ferrari - Cloud Solutions Architect - Google"><title>Unlocking an Android Smartphone with a Known Pattern Lock via ADB | Marco Ferrari - Cloud Solutions Architect - Google</title><meta name=generator content="Jekyll v4.1.1"><meta property=og:title content="Unlocking an Android Smartphone with a Known Pattern Lock via ADB"><meta name=author content="Marco Ferrari"><meta property=og:locale content=en_US><meta name=description content="Recently my Nexus 4 touchscreen stopped working. I wasn’t worried at all because I set up an automatic backup schedule with Titanium Backup that runs every night and uploads backup data to Google Drive. So everything under control right? Not so fast. I was able to restore everything on a spare Nexus 4 (that a friend lent me) except of my bank’s app. More precisely: I was able to restore the app and related data but it was not enough because this app also checks if the Android ID is what it’s expecting. Being the two IDs different (I did not restore the Android ID with Titanium Backup), the app (correctly) asked me to authenticate the new device. The only problem is that for such authentication I needed a One Time Password (OTP) generated via the app itself. I was locked out because I could not generate new codes with the app on my old Nexus 4 (touchscreen not working) and the geniuses that designed the bank’s authentication system did not think about backup codes. So what to do? What are the alternatives? (Solution for a normal person) buy a 2$ USB OTG cable and connect a USB mouse to the phone (Solution for an Engineer) simulate touch input via Android Debug Bridge Guess which path I chose… Goal The goal of this exercise is to unlock an Android system protected with a known pattern lock by simulating the touch input via ADB. Note that the approach described below is applicable not only to “pattern-locked” phones, but to all the cases when you cannot use the touchscreen. Prerequisites An Android smartphone or tablet with either USB Debugging mode enabled and an authorized ADB host to connect via ADB or unlocked bootloader and custom recovery (I tested the procedure with TWRP) An ADB host (I used a Linux box) Connect Target Android Device via ADB Reboot your device in recovery mode Start ADB on the host machine ferrarim@nuc-ferrarim:~$ adb devices * daemon not running. starting it now on port 5037 * * daemon started successfully * Connect the target phone via USB Confirm that ADB correctly recognized the phone: ferrarim@nuc-ferrarim:~$ adb devices List of devices attached 0123456789abcdef device Enable USB Debugging You can skip this step if you already have USB Debugging enabled on the target device. Remember that your phone must have a custom recovery installed (like TWRP that defaults to root access when connecting via ADB). Enable USB debugging via a root adb shell: ferrarim@nuc-ferrarim:~$ adb shell mako:/ $ echo &quot;persist.service.adb.enable=1&quot; &gt;&gt;/system/build.prop mako:/ $ echo &quot;persist.service.debuggable=1&quot; &gt;&gt;/system/build.prop mako:/ $ echo &quot;persist.sys.usb.config=mass_storage,adb&quot; &gt;&gt;/system/build.prop mako:/ $ exit Authorize the ADB Host If your ADB host is already authorized (i. e. you are able to connect via ADB when the target device is not running in recovery), you can skip this step. Let’s copy your ADB public key to the target device (this will overwrite the all the keys you have authorized in the past, so you may want to backup your /data/misc/adb/adb_keys file before manipulating it): ferrarim@nuc-ferrarim:~$ adb push ~/.android/adbkey.pub /data/misc/adb/adb_keys Reboot the Target Device in Normal Mode If the target device is in recovery mode, let’s reboot it ferrarim@nuc-ferrarim:~$ adb reboot Fix the “no permission” Error when Connecting via ADB If you are not able to connect to the target device when it’s in normal mode and you see the following output when running adb devices: ferrarim@nuc-ferrarim:~$ adb devices List of devices attached ???????????? no permissions You can try a couple of tricks: Reboot the ADB server: ferrarim@nuc-ferrarim:~$ adb kill-server ferrarim@nuc-ferrarim:~$ adb start-server If the above does not solve the issue, try setting the following udev rules in /etc/udev/rules.d/XX-android.rules where XX is a your desired prefix to set the order in which this rule file should be parsed considering other rule files. If you don’t need to enforce a particular order, just choose a prefix such as this rule file will end up at the end of the list of rule files (i. e. zz99-android.rules): SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0e79&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0502&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0b05&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;413c&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0489&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;091e&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;18d1&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;12d1&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;24e3&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2116&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0482&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;17ef&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1004&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;22b8&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0409&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2080&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0955&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2257&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;10a9&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1d4d&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0471&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04da&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;05c6&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1f53&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04e8&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04dd&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0fce&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0930&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;19d2&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1bbb&quot;, MODE=&quot;0666&quot; Then setup file permissions, restart udev and ADB server: ferrarim@nuc-ferrarim:~$ chmod 644 /etc/udev/rules.d/zz99-android.rules ferrarim@nuc-ferrarim:~$ chown root. /etc/udev/rules.d/zz99-android.rules ferrarim@nuc-ferrarim:~$ service udev restart ferrarim@nuc-ferrarim:~$ killall adb ferrarim@nuc-ferrarim:~$ adb start-server You should now have a fully working ADB environment connected to the target device (in normal mode). Simulating Touch Input via ADB We can simulate a user touching the screen and pressing buttons via ADB, but we first have to know the coordinates of the points to touch. After that you need to unlock the device, swipe up to reach the pattern lockscreen and then swipe the pattern. Get the Coordinates of the Pattern Lock Points To get the X and Y coordinates of the points to touch you should: Run an instance of the Android emulator and set it to the same resolution as the target device or run a physical device that, again, has the same resolution as the target device Connect to such device via ADB Listen for touch events: ferrarim@nuc-ferrarim:~$ adb shell getevent -l Touch each point of the pattern screen and write down its coordinates. Here is the output of a touch event that you are listening for. ABS_MT_POSITION_X and ABS_MT_POSITION_Y are the X and Y coordinates expressed in Hexadecimal numeral system /dev/input/event3: EV_KEY BTN_TOUCH DOWN /dev/input/event3: EV_ABS ABS_MT_POSITION_X 000002f5 /dev/input/event3: EV_ABS ABS_MT_POSITION_Y 0000069e Convert the nine (X,Y) tuples from Hexadecimal to Decimal Now you have the X and Y for each one of the nine points of the pattern lock. Run the Pattern Script Before developing my own script I found an existing implementation on GitHub. I forked that project and adapted it to my own needs (I set the (X,Y) coordinates of each point of the pattern lock and the pattern lock itself). The script does the following: Turn the screen on by simulating a power button press: adb shell input keyevent 26 Swipe up to reach the pattern lock screen: adb shell input swipe ${SWIPE_UP_X} ${SWIPE_UP_Y_FROM} ${SWIPE_UP_X} ${SWIPE_UP_Y_TO} Simulate the unlock pattern: # Start touch event adb shell sendevent /dev/input/event2 3 57 14 # Simulate input. $PATTERN is the unlock pattern of the target device for NUM in $PATTERN; do echo &quot;Sending $NUM: ${X[$NUM]}, ${Y[$NUM]}&quot; adb shell sendevent /dev/input/event2 3 53 ${X[$NUM]} adb shell sendevent /dev/input/event2 3 54 ${Y[$NUM]} adb shell sendevent /dev/input/event2 3 58 57 adb shell sendevent /dev/input/event2 0 0 0 done # End touch event adb shell sendevent /dev/input/event2 3 57 4294967295 adb shell sendevent /dev/input/event2 0 0 0 Conclusions With the right tools it was possible to do the following with the target device, with all the security patches applied and the latest version of Android ( LineageOS, 7.1.2): Gain root access Forcibly enable the USB Debug mode Authorize an ADB host to connect to the device Simulate touch input All of this was possible for one single reason: I unlocked the bootloader of my Android smartphone and installed a custom recovery that granted me (or anyone with physical access to the device) ROOT privileges. I would avoid doing it on devices that you intend to use to store sensitive data. On such devices you should also enable full-disk encryption!"><meta property=og:description content="Recently my Nexus 4 touchscreen stopped working. I wasn’t worried at all because I set up an automatic backup schedule with Titanium Backup that runs every night and uploads backup data to Google Drive. So everything under control right? Not so fast. I was able to restore everything on a spare Nexus 4 (that a friend lent me) except of my bank’s app. More precisely: I was able to restore the app and related data but it was not enough because this app also checks if the Android ID is what it’s expecting. Being the two IDs different (I did not restore the Android ID with Titanium Backup), the app (correctly) asked me to authenticate the new device. The only problem is that for such authentication I needed a One Time Password (OTP) generated via the app itself. I was locked out because I could not generate new codes with the app on my old Nexus 4 (touchscreen not working) and the geniuses that designed the bank’s authentication system did not think about backup codes. So what to do? What are the alternatives? (Solution for a normal person) buy a 2$ USB OTG cable and connect a USB mouse to the phone (Solution for an Engineer) simulate touch input via Android Debug Bridge Guess which path I chose… Goal The goal of this exercise is to unlock an Android system protected with a known pattern lock by simulating the touch input via ADB. Note that the approach described below is applicable not only to “pattern-locked” phones, but to all the cases when you cannot use the touchscreen. Prerequisites An Android smartphone or tablet with either USB Debugging mode enabled and an authorized ADB host to connect via ADB or unlocked bootloader and custom recovery (I tested the procedure with TWRP) An ADB host (I used a Linux box) Connect Target Android Device via ADB Reboot your device in recovery mode Start ADB on the host machine ferrarim@nuc-ferrarim:~$ adb devices * daemon not running. starting it now on port 5037 * * daemon started successfully * Connect the target phone via USB Confirm that ADB correctly recognized the phone: ferrarim@nuc-ferrarim:~$ adb devices List of devices attached 0123456789abcdef device Enable USB Debugging You can skip this step if you already have USB Debugging enabled on the target device. Remember that your phone must have a custom recovery installed (like TWRP that defaults to root access when connecting via ADB). Enable USB debugging via a root adb shell: ferrarim@nuc-ferrarim:~$ adb shell mako:/ $ echo &quot;persist.service.adb.enable=1&quot; &gt;&gt;/system/build.prop mako:/ $ echo &quot;persist.service.debuggable=1&quot; &gt;&gt;/system/build.prop mako:/ $ echo &quot;persist.sys.usb.config=mass_storage,adb&quot; &gt;&gt;/system/build.prop mako:/ $ exit Authorize the ADB Host If your ADB host is already authorized (i. e. you are able to connect via ADB when the target device is not running in recovery), you can skip this step. Let’s copy your ADB public key to the target device (this will overwrite the all the keys you have authorized in the past, so you may want to backup your /data/misc/adb/adb_keys file before manipulating it): ferrarim@nuc-ferrarim:~$ adb push ~/.android/adbkey.pub /data/misc/adb/adb_keys Reboot the Target Device in Normal Mode If the target device is in recovery mode, let’s reboot it ferrarim@nuc-ferrarim:~$ adb reboot Fix the “no permission” Error when Connecting via ADB If you are not able to connect to the target device when it’s in normal mode and you see the following output when running adb devices: ferrarim@nuc-ferrarim:~$ adb devices List of devices attached ???????????? no permissions You can try a couple of tricks: Reboot the ADB server: ferrarim@nuc-ferrarim:~$ adb kill-server ferrarim@nuc-ferrarim:~$ adb start-server If the above does not solve the issue, try setting the following udev rules in /etc/udev/rules.d/XX-android.rules where XX is a your desired prefix to set the order in which this rule file should be parsed considering other rule files. If you don’t need to enforce a particular order, just choose a prefix such as this rule file will end up at the end of the list of rule files (i. e. zz99-android.rules): SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0e79&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0502&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0b05&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;413c&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0489&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;091e&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;18d1&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;12d1&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;24e3&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2116&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0482&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;17ef&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1004&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;22b8&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0409&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2080&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0955&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2257&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;10a9&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1d4d&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0471&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04da&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;05c6&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1f53&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04e8&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04dd&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0fce&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0930&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;19d2&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1bbb&quot;, MODE=&quot;0666&quot; Then setup file permissions, restart udev and ADB server: ferrarim@nuc-ferrarim:~$ chmod 644 /etc/udev/rules.d/zz99-android.rules ferrarim@nuc-ferrarim:~$ chown root. /etc/udev/rules.d/zz99-android.rules ferrarim@nuc-ferrarim:~$ service udev restart ferrarim@nuc-ferrarim:~$ killall adb ferrarim@nuc-ferrarim:~$ adb start-server You should now have a fully working ADB environment connected to the target device (in normal mode). Simulating Touch Input via ADB We can simulate a user touching the screen and pressing buttons via ADB, but we first have to know the coordinates of the points to touch. After that you need to unlock the device, swipe up to reach the pattern lockscreen and then swipe the pattern. Get the Coordinates of the Pattern Lock Points To get the X and Y coordinates of the points to touch you should: Run an instance of the Android emulator and set it to the same resolution as the target device or run a physical device that, again, has the same resolution as the target device Connect to such device via ADB Listen for touch events: ferrarim@nuc-ferrarim:~$ adb shell getevent -l Touch each point of the pattern screen and write down its coordinates. Here is the output of a touch event that you are listening for. ABS_MT_POSITION_X and ABS_MT_POSITION_Y are the X and Y coordinates expressed in Hexadecimal numeral system /dev/input/event3: EV_KEY BTN_TOUCH DOWN /dev/input/event3: EV_ABS ABS_MT_POSITION_X 000002f5 /dev/input/event3: EV_ABS ABS_MT_POSITION_Y 0000069e Convert the nine (X,Y) tuples from Hexadecimal to Decimal Now you have the X and Y for each one of the nine points of the pattern lock. Run the Pattern Script Before developing my own script I found an existing implementation on GitHub. I forked that project and adapted it to my own needs (I set the (X,Y) coordinates of each point of the pattern lock and the pattern lock itself). The script does the following: Turn the screen on by simulating a power button press: adb shell input keyevent 26 Swipe up to reach the pattern lock screen: adb shell input swipe ${SWIPE_UP_X} ${SWIPE_UP_Y_FROM} ${SWIPE_UP_X} ${SWIPE_UP_Y_TO} Simulate the unlock pattern: # Start touch event adb shell sendevent /dev/input/event2 3 57 14 # Simulate input. $PATTERN is the unlock pattern of the target device for NUM in $PATTERN; do echo &quot;Sending $NUM: ${X[$NUM]}, ${Y[$NUM]}&quot; adb shell sendevent /dev/input/event2 3 53 ${X[$NUM]} adb shell sendevent /dev/input/event2 3 54 ${Y[$NUM]} adb shell sendevent /dev/input/event2 3 58 57 adb shell sendevent /dev/input/event2 0 0 0 done # End touch event adb shell sendevent /dev/input/event2 3 57 4294967295 adb shell sendevent /dev/input/event2 0 0 0 Conclusions With the right tools it was possible to do the following with the target device, with all the security patches applied and the latest version of Android ( LineageOS, 7.1.2): Gain root access Forcibly enable the USB Debug mode Authorize an ADB host to connect to the device Simulate touch input All of this was possible for one single reason: I unlocked the bootloader of my Android smartphone and installed a custom recovery that granted me (or anyone with physical access to the device) ROOT privileges. I would avoid doing it on devices that you intend to use to store sensitive data. On such devices you should also enable full-disk encryption!"><link rel=canonical href=https://ferrarimarco.info/blog/mobile/security/2017/10/18/unlocking-android-pattern/ ><meta property=og:url content=https://ferrarimarco.info/blog/mobile/security/2017/10/18/unlocking-android-pattern/ ><meta property=og:site_name content="Marco Ferrari - Cloud Solutions Architect - Google"><meta property=og:type content=article><meta property=article:published_time content=2017-10-18T00:00:00+00:00><meta name=twitter:card content=summary><meta property=twitter:title content="Unlocking an Android Smartphone with a Known Pattern Lock via ADB"><script type=application/ld+json>{"description":"Recently my Nexus 4 touchscreen stopped working. I wasn’t worried at all because I set up an automatic backup schedule with Titanium Backup that runs every night and uploads backup data to Google Drive. So everything under control right? Not so fast. I was able to restore everything on a spare Nexus 4 (that a friend lent me) except of my bank’s app. More precisely: I was able to restore the app and related data but it was not enough because this app also checks if the Android ID is what it’s expecting. Being the two IDs different (I did not restore the Android ID with Titanium Backup), the app (correctly) asked me to authenticate the new device. The only problem is that for such authentication I needed a One Time Password (OTP) generated via the app itself. I was locked out because I could not generate new codes with the app on my old Nexus 4 (touchscreen not working) and the geniuses that designed the bank’s authentication system did not think about backup codes. So what to do? What are the alternatives? (Solution for a normal person) buy a 2$ USB OTG cable and connect a USB mouse to the phone (Solution for an Engineer) simulate touch input via Android Debug Bridge Guess which path I chose… Goal The goal of this exercise is to unlock an Android system protected with a known pattern lock by simulating the touch input via ADB. Note that the approach described below is applicable not only to “pattern-locked” phones, but to all the cases when you cannot use the touchscreen. Prerequisites An Android smartphone or tablet with either USB Debugging mode enabled and an authorized ADB host to connect via ADB or unlocked bootloader and custom recovery (I tested the procedure with TWRP) An ADB host (I used a Linux box) Connect Target Android Device via ADB Reboot your device in recovery mode Start ADB on the host machine ferrarim@nuc-ferrarim:~$ adb devices * daemon not running. starting it now on port 5037 * * daemon started successfully * Connect the target phone via USB Confirm that ADB correctly recognized the phone: ferrarim@nuc-ferrarim:~$ adb devices List of devices attached 0123456789abcdef device Enable USB Debugging You can skip this step if you already have USB Debugging enabled on the target device. Remember that your phone must have a custom recovery installed (like TWRP that defaults to root access when connecting via ADB). Enable USB debugging via a root adb shell: ferrarim@nuc-ferrarim:~$ adb shell mako:/ $ echo &quot;persist.service.adb.enable=1&quot; &gt;&gt;/system/build.prop mako:/ $ echo &quot;persist.service.debuggable=1&quot; &gt;&gt;/system/build.prop mako:/ $ echo &quot;persist.sys.usb.config=mass_storage,adb&quot; &gt;&gt;/system/build.prop mako:/ $ exit Authorize the ADB Host If your ADB host is already authorized (i. e. you are able to connect via ADB when the target device is not running in recovery), you can skip this step. Let’s copy your ADB public key to the target device (this will overwrite the all the keys you have authorized in the past, so you may want to backup your /data/misc/adb/adb_keys file before manipulating it): ferrarim@nuc-ferrarim:~$ adb push ~/.android/adbkey.pub /data/misc/adb/adb_keys Reboot the Target Device in Normal Mode If the target device is in recovery mode, let’s reboot it ferrarim@nuc-ferrarim:~$ adb reboot Fix the “no permission” Error when Connecting via ADB If you are not able to connect to the target device when it’s in normal mode and you see the following output when running adb devices: ferrarim@nuc-ferrarim:~$ adb devices List of devices attached ???????????? no permissions You can try a couple of tricks: Reboot the ADB server: ferrarim@nuc-ferrarim:~$ adb kill-server ferrarim@nuc-ferrarim:~$ adb start-server If the above does not solve the issue, try setting the following udev rules in /etc/udev/rules.d/XX-android.rules where XX is a your desired prefix to set the order in which this rule file should be parsed considering other rule files. If you don’t need to enforce a particular order, just choose a prefix such as this rule file will end up at the end of the list of rule files (i. e. zz99-android.rules): SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0e79&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0502&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0b05&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;413c&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0489&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;091e&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;18d1&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0bb4&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;12d1&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;24e3&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2116&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0482&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;17ef&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1004&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;22b8&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0409&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2080&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0955&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;2257&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;10a9&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1d4d&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0471&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04da&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;05c6&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1f53&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04e8&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;04dd&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0fce&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;0930&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;19d2&quot;, MODE=&quot;0666&quot; SUBSYSTEM==&quot;usb&quot;, ATTRS{idVendor}==&quot;1bbb&quot;, MODE=&quot;0666&quot; Then setup file permissions, restart udev and ADB server: ferrarim@nuc-ferrarim:~$ chmod 644 /etc/udev/rules.d/zz99-android.rules ferrarim@nuc-ferrarim:~$ chown root. /etc/udev/rules.d/zz99-android.rules ferrarim@nuc-ferrarim:~$ service udev restart ferrarim@nuc-ferrarim:~$ killall adb ferrarim@nuc-ferrarim:~$ adb start-server You should now have a fully working ADB environment connected to the target device (in normal mode). Simulating Touch Input via ADB We can simulate a user touching the screen and pressing buttons via ADB, but we first have to know the coordinates of the points to touch. After that you need to unlock the device, swipe up to reach the pattern lockscreen and then swipe the pattern. Get the Coordinates of the Pattern Lock Points To get the X and Y coordinates of the points to touch you should: Run an instance of the Android emulator and set it to the same resolution as the target device or run a physical device that, again, has the same resolution as the target device Connect to such device via ADB Listen for touch events: ferrarim@nuc-ferrarim:~$ adb shell getevent -l Touch each point of the pattern screen and write down its coordinates. Here is the output of a touch event that you are listening for. ABS_MT_POSITION_X and ABS_MT_POSITION_Y are the X and Y coordinates expressed in Hexadecimal numeral system /dev/input/event3: EV_KEY BTN_TOUCH DOWN /dev/input/event3: EV_ABS ABS_MT_POSITION_X 000002f5 /dev/input/event3: EV_ABS ABS_MT_POSITION_Y 0000069e Convert the nine (X,Y) tuples from Hexadecimal to Decimal Now you have the X and Y for each one of the nine points of the pattern lock. Run the Pattern Script Before developing my own script I found an existing implementation on GitHub. I forked that project and adapted it to my own needs (I set the (X,Y) coordinates of each point of the pattern lock and the pattern lock itself). The script does the following: Turn the screen on by simulating a power button press: adb shell input keyevent 26 Swipe up to reach the pattern lock screen: adb shell input swipe ${SWIPE_UP_X} ${SWIPE_UP_Y_FROM} ${SWIPE_UP_X} ${SWIPE_UP_Y_TO} Simulate the unlock pattern: # Start touch event adb shell sendevent /dev/input/event2 3 57 14 # Simulate input. $PATTERN is the unlock pattern of the target device for NUM in $PATTERN; do echo &quot;Sending $NUM: ${X[$NUM]}, ${Y[$NUM]}&quot; adb shell sendevent /dev/input/event2 3 53 ${X[$NUM]} adb shell sendevent /dev/input/event2 3 54 ${Y[$NUM]} adb shell sendevent /dev/input/event2 3 58 57 adb shell sendevent /dev/input/event2 0 0 0 done # End touch event adb shell sendevent /dev/input/event2 3 57 4294967295 adb shell sendevent /dev/input/event2 0 0 0 Conclusions With the right tools it was possible to do the following with the target device, with all the security patches applied and the latest version of Android ( LineageOS, 7.1.2): Gain root access Forcibly enable the USB Debug mode Authorize an ADB host to connect to the device Simulate touch input All of this was possible for one single reason: I unlocked the bootloader of my Android smartphone and installed a custom recovery that granted me (or anyone with physical access to the device) ROOT privileges. I would avoid doing it on devices that you intend to use to store sensitive data. On such devices you should also enable full-disk encryption!","datePublished":"2017-10-18T00:00:00+00:00","url":"https://ferrarimarco.info/blog/mobile/security/2017/10/18/unlocking-android-pattern/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ferrarimarco.info/blog/mobile/security/2017/10/18/unlocking-android-pattern/"},"author":{"@type":"Person","name":"Marco Ferrari"},"headline":"Unlocking an Android Smartphone with a Known Pattern Lock via ADB","dateModified":"2017-10-18T00:00:00+00:00","@context":"https://schema.org"}</script><link href="https://fonts.googleapis.com/css?family=Roboto+Slab|Roboto" rel=stylesheet type=text/css></head><body><header class=site-header><div class=wrapper><!--[if lt IE 11]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]--> <a class=site-title href=/ >Marco Ferrari - Cloud Solutions Architect - Google</a><nav class=site-nav><div class=trigger><a class=page-link href=/blog/ >Blog</a></div></nav></div></header><div class=page-content><div class=wrapper><article class=post itemscope itemtype=http://schema.org/BlogPosting><header class=post-header><h1 class=post-title itemprop="name headline">Unlocking an Android Smartphone with a Known Pattern Lock via ADB</h1><div class=post-meta><p><time datetime=2017-10-18T00:00:00+00:00 itemprop=datePublished><a href=/blog/archive/2017/ >2017 </a>- <a href=/blog/archive/2017/10/ >10 </a>-18</time></p></div></header><div class=post-content itemprop=articleBody><p>Recently my <a href=https://en.wikipedia.org/wiki/Nexus_4>Nexus 4</a> touchscreen stopped working.</p><p>I wasn’t worried at all because I set up an automatic backup schedule with <a href="https://play.google.com/store/apps/details?id=com.keramidas.TitaniumBackup&amp;hl=it">Titanium Backup</a> that runs every night and uploads backup data to Google Drive. So everything under control right? Not so fast.</p><p>I was able to restore everything on a spare Nexus 4 (that a friend lent me) except of my <a href="https://play.google.com/store/apps/details?id=com.unicredit&amp;hl=it">bank’s app</a>. More precisely: I was able to restore the app and related data but it was not enough because this app also checks if the Android ID is what it’s expecting. Being the two IDs different (I did not restore the Android ID with Titanium Backup), the app (correctly) asked me to authenticate the new device. The only problem is that for such authentication I needed a <a href=https://en.wikipedia.org/wiki/One-time_password>One Time Password (OTP)</a> generated via the app itself. I was locked out because I could not generate new codes with the app on my old Nexus 4 (touchscreen not working) and the geniuses that designed the bank’s authentication system did not think about backup codes.</p><p>So what to do? What are the alternatives?</p><ul><li>(Solution for a normal person) buy a 2$ USB OTG cable and connect a USB mouse to the phone</li><li>(Solution for an Engineer) simulate touch input via <a href=https://developer.android.com/studio/command-line/adb.html>Android Debug Bridge</a></li></ul><p>Guess which path I chose…</p><h2 id=goal>Goal</h2><p>The goal of this exercise is to <strong>unlock an Android system protected with a known pattern lock by simulating the touch input via ADB</strong>.</p><p>Note that the approach described below is applicable not only to “pattern-locked” phones, but to all the cases when you cannot use the touchscreen.</p><h2 id=prerequisites>Prerequisites</h2><ol><li>An Android smartphone or tablet with either <strong>USB Debugging mode enabled and an authorized ADB host to connect via ADB</strong> or <strong>unlocked bootloader and custom recovery (I tested the procedure with <a href=https://twrp.me/ >TWRP</a>)</strong></li><li>An ADB host (I used a Linux box)</li></ol><h2 id=connect-target-android-device-via-adb>Connect Target Android Device via ADB</h2><ol><li>Reboot your device in <em>recovery mode</em></li><li><p>Start ADB on the host machine</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb devices
 <span class=k>*</span> daemon not running. starting it now on port 5037 <span class=k>*</span>
 <span class=k>*</span> daemon started successfully <span class=k>*</span>
</code></pre></div></div></li><li>Connect the target phone via USB</li><li><p>Confirm that ADB correctly recognized the phone:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb devices
 List of devices attached
 0123456789abcdef    device
</code></pre></div></div></li></ol><h2 id=enable-usb-debugging>Enable USB Debugging</h2><p>You can skip this step if you already have USB Debugging enabled on the target device. Remember that your phone must have a custom recovery installed (like TWRP that defaults to <em>root</em> access when connecting via ADB).</p><ol><li><p>Enable USB debugging via a root <code class="language-plaintext highlighter-rouge">adb shell</code>:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb shell
 mako:/ <span class=nv>$ </span><span class=nb>echo</span> <span class=s2>"persist.service.adb.enable=1"</span> <span class=o>&gt;&gt;</span>/system/build.prop
 mako:/ <span class=nv>$ </span><span class=nb>echo</span> <span class=s2>"persist.service.debuggable=1"</span> <span class=o>&gt;&gt;</span>/system/build.prop
 mako:/ <span class=nv>$ </span><span class=nb>echo</span> <span class=s2>"persist.sys.usb.config=mass_storage,adb"</span> <span class=o>&gt;&gt;</span>/system/build.prop
 mako:/ <span class=nv>$ </span><span class=nb>exit</span>
</code></pre></div></div></li></ol><h2 id=authorize-the-adb-host>Authorize the ADB Host</h2><p>If your ADB host is already authorized (i. e. you are able to connect via ADB when the target device is not running in recovery), you can skip this step.</p><p>Let’s copy your ADB public key to the target device (this will overwrite the all the keys you have authorized in the past, so you may want to backup your <code class="language-plaintext highlighter-rouge">/data/misc/adb/adb_keys</code> file before manipulating it):</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code>ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb push ~/.android/adbkey.pub /data/misc/adb/adb_keys
</code></pre></div></div><h2 id=reboot-the-target-device-in-normal-mode>Reboot the Target Device in Normal Mode</h2><p>If the target device is in recovery mode, let’s reboot it</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code>ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb reboot
</code></pre></div></div><h2 id=fix-the-no-permission-error-when-connecting-via-adb>Fix the “no permission” Error when Connecting via ADB</h2><p>If you are not able to connect to the target device when it’s in normal mode and you see the following output when running <code class="language-plaintext highlighter-rouge">adb devices</code>:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code>ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb devices
List of devices attached
????????????   no permissions
</code></pre></div></div><p>You can try a couple of tricks:</p><ul><li><p>Reboot the ADB server:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code>ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb kill-server
ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb start-server
</code></pre></div></div></li><li><p>If the above does not solve the issue, try setting the following <code class="language-plaintext highlighter-rouge">udev</code> rules in <code class="language-plaintext highlighter-rouge">/etc/udev/rules.d/XX-android.rules</code> where <em>XX</em> is a your desired prefix to set the order in which this rule file should be parsed considering other rule files. If you don’t need to enforce a particular order, just choose a prefix such as this rule file will end up at the end of the list of rule files (i. e. <code class="language-plaintext highlighter-rouge">zz99-android.rules</code>):</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0bb4"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0e79"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0502"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0b05"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"413c"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0489"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"091e"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"18d1"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0bb4"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"12d1"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"24e3"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"2116"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0482"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"17ef"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"1004"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"22b8"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0409"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"2080"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0955"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"2257"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"10a9"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"1d4d"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0471"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"04da"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"05c6"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"1f53"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"04e8"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"04dd"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0fce"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"0930"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"19d2"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
<span class=nv>SUBSYSTEM</span><span class=o>==</span><span class=s2>"usb"</span>, ATTRS<span class=o>{</span>idVendor<span class=o>}==</span><span class=s2>"1bbb"</span>, <span class=nv>MODE</span><span class=o>=</span><span class=s2>"0666"</span>
</code></pre></div></div><p>Then setup file permissions, restart <code class="language-plaintext highlighter-rouge">udev</code> and ADB server:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code>ferrarim@nuc-ferrarim:~<span class=nv>$ </span><span class=nb>chmod </span>644   /etc/udev/rules.d/zz99-android.rules
ferrarim@nuc-ferrarim:~<span class=nv>$ </span><span class=nb>chown </span>root. /etc/udev/rules.d/zz99-android.rules
ferrarim@nuc-ferrarim:~<span class=nv>$ </span>service udev restart
ferrarim@nuc-ferrarim:~<span class=nv>$ </span>killall adb
ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb start-server
</code></pre></div></div><p>You should now have a fully working ADB environment connected to the target device (in normal mode).</p></li></ul><h2 id=simulating-touch-input-via-adb>Simulating Touch Input via ADB</h2><p>We can simulate a user touching the screen and pressing buttons via ADB, but we first have to know the coordinates of the points to touch. After that you need to unlock the device, swipe up to reach the pattern lockscreen and then swipe the pattern.</p><h3 id=get-the-coordinates-of-the-pattern-lock-points>Get the Coordinates of the Pattern Lock Points</h3><p>To get the X and Y coordinates of the points to touch you should:</p><ol><li>Run an instance of the Android emulator and set it to the same resolution as the target device or run a physical device that, again, has the same resolution as the target device</li><li>Connect to such device via ADB</li><li><p>Listen for touch events:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> ferrarim@nuc-ferrarim:~<span class=nv>$ </span>adb shell getevent <span class=nt>-l</span>
</code></pre></div></div></li><li><p>Touch each point of the pattern screen and write down its coordinates. Here is the output of a touch event that you are listening for. <code class="language-plaintext highlighter-rouge">ABS_MT_POSITION_X</code> and <code class="language-plaintext highlighter-rouge">ABS_MT_POSITION_Y</code> are the X and Y coordinates expressed in <a href=https://en.wikipedia.org/wiki/Hexadecimal>Hexadecimal numeral system</a></p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> /dev/input/event3: EV_KEY       BTN_TOUCH            DOWN
 /dev/input/event3: EV_ABS       ABS_MT_POSITION_X    000002f5
 /dev/input/event3: EV_ABS       ABS_MT_POSITION_Y    0000069e
</code></pre></div></div></li><li>Convert the nine (X,Y) tuples from Hexadecimal to Decimal</li></ol><p>Now you have the X and Y for each one of the nine points of the pattern lock.</p><h3 id=run-the-pattern-script>Run the Pattern Script</h3><p>Before developing my own script I found an existing implementation on GitHub. <a href=https://github.com/ferrarimarco/android-pattern-unlock>I forked that project</a> and adapted it to my own needs (I set the (X,Y) coordinates of each point of the pattern lock and the pattern lock itself).</p><p>The script does the following:</p><ol><li><p>Turn the screen on by simulating a power button press:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> adb shell input keyevent 26
</code></pre></div></div></li><li><p>Swipe up to reach the pattern lock screen:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> adb shell input swipe <span class=k>${</span><span class=nv>SWIPE_UP_X</span><span class=k>}</span> <span class=k>${</span><span class=nv>SWIPE_UP_Y_FROM</span><span class=k>}</span> <span class=k>${</span><span class=nv>SWIPE_UP_X</span><span class=k>}</span> <span class=k>${</span><span class=nv>SWIPE_UP_Y_TO</span><span class=k>}</span>
</code></pre></div></div></li><li><p>Simulate the unlock pattern:</p><div class="language-shell highlighter-rouge"><div class=highlight><pre class=highlight><code> <span class=c># Start touch event</span>
 adb shell sendevent /dev/input/event2 3 57 14

 <span class=c># Simulate input. $PATTERN is the unlock pattern of the target device</span>
 <span class=k>for </span>NUM <span class=k>in</span> <span class=nv>$PATTERN</span><span class=p>;</span> <span class=k>do
     </span><span class=nb>echo</span> <span class=s2>"Sending </span><span class=nv>$NUM</span><span class=s2>: </span><span class=k>${</span><span class=nv>X</span><span class=p>[</span><span class=nv>$NUM</span><span class=p>]</span><span class=k>}</span><span class=s2>, </span><span class=k>${</span><span class=nv>Y</span><span class=p>[</span><span class=nv>$NUM</span><span class=p>]</span><span class=k>}</span><span class=s2>"</span>
     adb shell sendevent /dev/input/event2 3 53 <span class=k>${</span><span class=nv>X</span><span class=p>[</span><span class=nv>$NUM</span><span class=p>]</span><span class=k>}</span>
     adb shell sendevent /dev/input/event2 3 54 <span class=k>${</span><span class=nv>Y</span><span class=p>[</span><span class=nv>$NUM</span><span class=p>]</span><span class=k>}</span>
     adb shell sendevent /dev/input/event2 3 58 57
     adb shell sendevent /dev/input/event2 0 0 0
 <span class=k>done</span>

 <span class=c># End touch event</span>
 adb shell sendevent /dev/input/event2 3 57 4294967295
 adb shell sendevent /dev/input/event2 0 0 0
</code></pre></div></div></li></ol><h2 id=conclusions>Conclusions</h2><p>With the right tools it was possible to do the following with the target device, with all the security patches applied and the latest version of Android ( LineageOS, 7.1.2):</p><ul><li>Gain root access</li><li>Forcibly enable the USB Debug mode</li><li>Authorize an ADB host to connect to the device</li><li>Simulate touch input</li></ul><p>All of this was possible for one single reason: <strong>I unlocked the bootloader of my Android smartphone and installed a custom recovery that granted me (or anyone with physical access to the device) ROOT privileges.</strong></p><p>I would avoid doing it on devices that you intend to use to store sensitive data. On such devices you should also enable full-disk encryption!</p></div><div class="post-footer post-meta"><p>Categories: <a href=/blog/archive/category/mobile/ >mobile</a> <a href=/blog/archive/category/security/ >security</a></p><p>Tags: <a href=/blog/archive/tag/android/ >android</a> <a href=/blog/archive/tag/pattern-lock/ >pattern-lock</a></p><p>Subscribe <a href=/feed.xml>via RSS</a></p></div></article></div></div><footer class=site-footer><div class=wrapper><h2 class=footer-heading>Contacts</h2><div class=footer-col-wrapper><div class=footer-col><ul class=contact-list><li>Marco Ferrari - CV: <a href=https://bit.ly/cv-ferrari-marco class=bold>ENG</a></li><li><a href=mailto:ferrari.marco@gmail.com><span class=icon><img alt="email icon" src=/assets/images/contacts/email.png> </span><span class=username>Email: ferrari.marco@gmail.com</span></a></li><li><a href=https://github.com/ferrarimarco rel=me><span class=icon><img alt="github logo" src=/assets/images/contacts/github.png> </span><span class=username>Github: ferrarimarco</span></a></li><li><a href=https://www.facebook.com/ferrari.marco rel=me><span class=icon><img alt="facebook logo" src=/assets/images/contacts/facebook.png> </span><span class=username>Facebook: ferrari.marco</span></a></li><li><a href=https://twitter.com/ferrarimarco rel=me><span class=icon><img alt="twitter logo" src=/assets/images/contacts/twitter.png> </span><span class=username>Twitter: @ferrarimarco</span></a></li><li><a href=https://www.linkedin.com/in/ferrarimark rel=me data-proofer-ignore><span class=icon><img alt="linkedin logo" src=/assets/images/contacts/linkedin.png> </span><span class=username>Linkedin: ferrarimark</span></a></li><li><a href=https://stackoverflow.com/users/653462 rel=me><span class=icon><img alt="stackoverflow logo" src=/assets/images/contacts/stackoverflow.png> </span><span class=username>Stackoverflow: marco-ferrari</span></a></li></ul></div></div></div></footer><script>(function (b, o, i, l, e, r) {
    b.GoogleAnalyticsObject = l; b[l] || (b[l] =
      function () { (b[l].q = b[l].q || []).push(arguments) }); b[l].l = +new Date;
    e = o.createElement(i); r = o.getElementsByTagName(i)[0];
    e.src = '//www.google-analytics.com/analytics.js';
    r.parentNode.insertBefore(e, r)
  }(window, document, 'script', 'ga'));
  ga('create', 'UA-18832248-1'); ga('send', 'pageview');</script><script src=/assets/javascript/index-8971778a9c.min.js></script></body></html>